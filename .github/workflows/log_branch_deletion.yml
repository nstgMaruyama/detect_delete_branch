name: Log to Wiki

on:
  delete:
  create:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Wiki
        run: |
          # Wikiãƒªãƒã‚¸ãƒˆãƒªã‚’ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¯ãƒ­ãƒ¼ãƒ³
          # èªè¨¼ã«ã¯ GITHUB_TOKEN ã‚’ä½¿ç”¨
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki_repo

      - name: Update Wiki Page
        run: |
          cd wiki_repo
          LOG_FILE="Branch-Log.md"

          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ä½œæˆ
          if [ ! -f "$LOG_FILE" ]; then
            echo "# ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒæ“ä½œå±¥æ­´ï¼ˆWikiç‰ˆï¼‰" > "$LOG_FILE"
            echo "| æ—¥æ™‚ (JST) | ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ |" >> "$LOG_FILE"
            echo "| --- | --- | --- | --- |" >> "$LOG_FILE"
          fi

          # ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
          TIMESTAMP=$(date -d "+9 hours" '+%Y-%m-%d %H:%M:%S JST')
          ACTOR="${{ github.actor }}"
          ACTION="${{ github.event_name == 'create' && 'âœ¨ ä½œæˆ' || 'ğŸ—‘ï¸ å‰Šé™¤' }}"
          BRANCH="${{ github.event.ref }}"

          # ãƒ­ã‚°ã‚’è¿½è¨˜
          echo "| $TIMESTAMP | $ACTOR | $ACTION | \`$BRANCH\` |" >> "$LOG_FILE"

          # Gitã®è¨­å®šã¨ãƒ—ãƒƒã‚·ãƒ¥
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add "$LOG_FILE"
          git commit -m "Update branch activity log"
          git push origin master || git push origin main